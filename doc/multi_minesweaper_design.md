# **Multi Minesweeper Design Document (改訂版)**

## アイデア：

- ターン順番に関しては途中参加と退出を考えて、現在の順番の一番後ろにキューを入れる感じでどうだろうか？
-

## **1. 概要**

本ドキュメントでは、Vue 3 + Pinia + Laravel + Inertia
で実装するオンライン協力型マインスイーパーの仕様・設計を記述します。  
シングルプレイは完了しており、次のマルチプレイ機能実装に向け、以下の点を中心に整理しています。

- **モード選択**: シングル / マルチプレイ
- **ルーム管理**: ルーム作成、参加、状態保存、削除（マジックリンクのみ）
- **ターン制ゲーム進行（1 ターン 1 タイル展開 + フラグは合計 5 アクション）**
- **web socket通信**: laravel Echoとreverbを使う。
- **ブラウザ保存**: ホストだけが一定期間ルーム情報をローカルに保存

---

## **2. 技術スタック**

- **フロントエンド**:
    - Vue 3 (Composition API), Pinia
- **バックエンド**:
    - Laravel, Inertia.js
- **通信方式**:
    - **ポーリング**: 数秒おきにフロントからサーバーへ更新確認
- **デプロイ環境**:
    - AWS Lightsail 等を想定

---

## **3. 機能要件**

### **3.1 シングルプレイ**

1. **難易度選択**: easy, normal, hard, very hard
2. **ボード状態の保存**:
    - ローカルストレージのみ
    - サーバー側 DB 保存は不要

### **3.2 マルチプレイ**

1. **ルーム作成 & 参加**
    - **マジックリンク** のみを利用して参加
    - 参加人数の上限 (2 ～ 4 人など)
    - ルーム状態の保存：DB に保存 → 再参加時に復元
2. **ターン制**
    - 1 ターンで **1 タイルを開く** か、**フラグを立てる/外す合計最大 5 回** のいずれかが可能
        - 例: 1 ターンで「フラグを 3 回立てる + 2 回外す」= 合計 5 アクション
    - どちらかを行ったらターン終了
3. **web socketによるライブプレイ**
    - クライアント側からサーバーへ「最新のボード情報」や「ターン情報」を取得
    - サーバー側では最新の `room_states` を返却

### **3.3 ルーム管理要件**

1. **ルーム作成**
    - DB に新規レコード作成
    - **magic_token**（マジックリンク用のランダム文字列）を発行し、URL 形式で返却
    - 上限人数を指定可能
2. **ルーム再開**
    - 参加者が 0 になったらルームは停止状態になるが、DB に保存した状態をもとに再入室可
    - ホストのみ、ブラウザにルーム情報（`magic_token`など）を一定期間ローカル保存
3. **ルーム削除**
    - 30 日間アクティビティが無い場合、自動削除（論理削除）
    - 手動削除

### **3.4 ボード設定**

- **ボードサイズ**: 作成者が可変で設定
- **地雷数の決定**: `(H x W) * 0.4` などの割合で決定可能
- **リセット**: ルーム作成者が任意タイミングでリセット

---

## **4. 画面遷移 / UI フロー (概略)**

1. **ホーム画面**
    - シングルプレイ / マルチプレイの選択
2. **シングルプレイ画面**
    - 難易度選択 → プレイ → 結果
3. **マルチプレイ画面**
    - ルーム作成 or マジックリンクによる参加
    - ルーム内画面（ボード表示 + ターン情報）
        - **ターン開始** → **1 タイル開く or フラグアクション（最大 5 回）** → **ターン終了**
    - ポーリングによる更新

---

## **5. データベース設計**

**マイグレーションファイルを見てください。**
**規模感によっては作成**

## **7. API 設計**

### **7.1 ホーム画面**

- `GET /`
    - シングル / マルチプレイの選択画面

### **7.2 シングルプレイ**

- `GET /single`
    - 難易度選択画面
- `GET /single/play`
    - シングルプレイ開始画面

### **7.3 マルチプレイ**

#### 7.3.1 ルーム作成

- `POST /multi/play/create`
- **Request Body** (例):
  ```json
  {
    "max_participants": 4
  }
  ```
- **Response Body** (例):
  ```json
  {
    "magic_token": "abcdef123456",
    "room_url": "https://example.com/multi/play/abcdef123456"
  }
  ```

#### 7.3.2 ルーム状態取得

- `GET /multi/play/{magic_token}/state`
- **Response Body** (例):
  ```json
  {
    "board_state": {},
    "turn_info": {},
    "participants": [
      {
        "user_id": "string"
      }
    ]
  }
  ```

#### 7.3.3 ルーム状態更新

- `PUT /multi/play/{magic_token}/update`
- **Request Body** (例):
  ```json
  {
    "board_state": {},
    "turn_info": {}
  }
  ```
- **Response Body** (例):
  ```json
  {
    "message": "Board state updated"
  }
  ```

#### 7.3.4 ルーム退出

- `DELETE /multi/play/{magic_token}/participants`
- **Request Body** (例):
  ```json
  {
    "user_id": "user_12345"
  }
  ```
- **Response Body** (例):
  ```json
  {
    "message": "Successfully left the room"
  }
  ```

---

## **8. セキュリティ要件**

1. **HTTPS**: 通信内容の保護
2. **トークンの難読化**: `magic_token` は UUID や暗号学的に安全なランダム値を利用
3. **セッション管理**: Laravel のセッション / クッキーでユーザーを識別
4. **ブラウザ保存**: ホストのみルーム情報をローカルストレージ等に保存

---

## **9. 運用・パフォーマンス**

1. **ルーム自動削除**:
    - 30 日経過後に論理削除 (`deleted_at` を更新)
2. **DB Index 設計**:
    - `magic_token` や `room_id` にはインデックスを付与
3. **同時アクセス**:
    - 上限 4 人程度であれば大きな負荷にはならないが、将来的な拡張を視野に

---

## **10. セットアップ例**

```bash
# プロジェクト作成
composer create-project laravel/laravel project_name

# 認証テンプレート (breeze) のインストール
composer require laravel/breeze --dev

# Vue + Inertia の設定
php artisan breeze:install vue
npm install
npm run dev

# マイグレーション
php artisan migrate

# ローカル開発サーバー起動
php artisan serve
```

---

## **11. 最終補足**

1. **1 ターンあたりのアクションルール**
    - 1 タイルを開く → 即ターン終了
    - フラグ設置 or フラグ除去 → 1 回ごとにアクションカウントが増え、合計 5 アクションでターン終了
      2**マジックリンク以外からの参加不可**
    - ルーム検索やパスワード入力は廃止し、マジックリンクの共有が唯一の参加手段
